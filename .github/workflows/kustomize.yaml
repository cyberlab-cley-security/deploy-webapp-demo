name: Update Kustomization for ArgoCD

on:
  workflow_dispatch:
    inputs:
      IMAGE_URI:
        description: 'Full Docker image URI (ex: 016246143337.dkr.ecr.us-east-1.amazonaws.com/chris:0.0.1)'
        type: string
        default: '<CHANGE ME>'
        required: true

jobs:

  ###############################################
  # Check Kubernetes YAML with Checkov
  ###############################################
  check_k8s_with_checkov:
    name: Kubernetes Security Scan (Checkov)
    runs-on: ubuntu-latest

    steps:
      # Checkout repo to access YAML files
      - name: Checkout repository
        uses: actions/checkout@v3

      # Install Python + Checkov
      - name: Install Checkov
        run: |
          pip install checkov
          checkov --version

      # Run Checkov on all K8s manifests
      - name: Scan Kubernetes YAML with Checkov
        run: |
          echo "Running Checkov on Kubernetes manifests..."
          checkov --framework kubernetes -d .
        continue-on-error: true

  ###############################################
  # Update kustomization.yaml 
  ###############################################
  update_kustomization:
    name: Update Kustomization YAML
    runs-on: ubuntu-latest
    needs: check_k8s_with_checkov 

    steps:
      # Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.PERSONAL_GITHUB_TOKEN }}

      # Install yq
      - name: Install yq
        run: |
          sudo wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/local/bin/yq
          sudo chmod +x /usr/local/bin/yq
          yq --version

      # Update kustomization.yaml
      - name: Update kustomization.yaml image
        run: |
          IMAGE_URI="${{ github.event.inputs.IMAGE_URI }}"
          echo "Updating kustomization.yaml with image: $IMAGE_URI"

          IMAGE_TAG=$(echo "$IMAGE_URI" | sed 's/.*:\(.*\)/\1/')
          IMAGE_NAME=$(echo "$IMAGE_URI" | sed 's/\(.*\):.*/\1/')
          
          if [ "$IMAGE_TAG" == "$IMAGE_NAME" ]; then
            IMAGE_NAME=$(echo $IMAGE_URI | cut -d':' -f1)
            IMAGE_TAG=$(echo $IMAGE_URI | cut -d':' -f2)
          fi
          
          echo "Extracted Name: $IMAGE_NAME"
          echo "Extracted Tag: $IMAGE_TAG"

          yq eval -i ".images[0].newName = \"$IMAGE_NAME\" | .images[0].newTag = \"$IMAGE_TAG\"" ./kustomization.yaml

  ###############################################
  # Commit and push changes 
  ###############################################
      - name: Commit and push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          file_pattern: kustomization.yaml
          commit_message: "Update image to ${{ github.event.inputs.IMAGE_URI }}"
          commit_user_name: github-actions[bot]
          commit_user_email: github-actions[bot]@users.noreply.github.com
